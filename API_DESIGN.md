# API Design Document

This document outlines the API structure required to support the "OneScript" application, linking the front-end features to backend logic.

## 1. Authentication & Team Management
*Handled by Neon Auth and mapped to local Postgres users.*

*   **`POST /api/auth/register`**
    *   **Purpose:** Registers a new user and organization in Neon/Postgres.
*   **`POST /api/auth/invite`**
    *   **Purpose:** Invites a member to an existing organization via email.
*   **`GET /api/auth/me`**
    *   **Purpose:** Returns the current authenticated user and their organization context.

## 2. Public Widget API (CORS Enabled)
*These endpoints must allow requests from `*` origins and process `data-id` for identification.*

*   **`GET /api/widget/config?id={data-id}`**
    *   **Purpose:** Fetches the bot's appearance (colors, names), enabled sections, and initial welcome message.
    *   **Response:** JSON with branding, active status, and `initial_messages`.
*   **`POST /api/widget/session`**
    *   **Purpose:** Initializes a new chat session for a visitor.
    *   **Body:** `{ distinct_id: string, metadata: object }`
    *   **Response:** Returns a temporary JWT token valid for 2 hours.
*   **`POST /api/widget/chat`**
    *   **Purpose:** Handles message submission.
    *   **Body:** `{ message: string, session_token: string, section_id: optional_string }`
    *   **Response:** Streaming text response (SSE) generated by the AI.
*   **`POST /api/widget/escalate`**
    *   **Purpose:** Flags a conversation as "Escalated" when the bot fails.
    *   **Body:** `{ session_id: string, reason: string }`

## 3. Dashboard API (Protected)
*Requires valid user session/cookies.*

### 3.1. Knowledge Base (RAG)
*   **`POST /api/sources/crawl`**
    *   **Purpose:** Triggers internal custom crawler (Puppeteer/Playwright).
    *   **Body:** `{ url: string, depth: number }`
    *   **Async Process:** Triggers background job: Crawl -> Cleaning -> Embed (OpenAI) -> Store (Neon pgvector).
*   **`POST /api/sources/file`**
    *   **Purpose:** Uploads CSV/Text files.
    *   **Body:** `Multipart/form-data`.
*   **`GET /api/sources`**
    *   **Purpose:** List all knowledge sources with status (Active/Training).
*   **`DELETE /api/sources/{id}`**
    *   **Purpose:** Removes a source and its vector embeddings.

### 3.2. Sections & Routing
*   **`GET /api/sections`**
    *   **Purpose:** List all configured chatbot sections.
*   **`POST /api/sections`**
    *   **Purpose:** Create/Update a section.
    *   **Body:** `{ name, tone, allowed_topics, linked_source_ids[] }`

### 3.3. Analytics & Inbox
*   **`GET /api/dashboard/stats`**
    *   **Purpose:** Returns counts for Setup Progress, Sources, and usage limits.
*   **`GET /api/conversations`**
    *   **Purpose:** List recent conversations for the Inbox view.
    *   **Query Params:** `?filter=all|escalated&search={query}`
*   **`GET /api/conversations/{id}/messages`**
    *   **Purpose:** Fetch full history for a specific chat.
*   **`POST /api/conversations/{id}/reply`**
    *   **Purpose:** Send a manual admin reply.
    *   **Body:** `{ message: string }`
    *   **Effect:** Appends message to chat stream as role="assistant".

## 4. AI & Systems (Internal)
*   **`POST /api/ai/generate`**
    *   **Purpose:** Core generation entry point (used by widget and test simulator).
    *   **Logic:**
        1. Context retrieval (Neon pgvector similarity search).
        2. Strictness check (Guardrails).
        3. LLM Generation (OpenAI).
*   **`POST /api/ai/summarize-history`**
    *   **Purpose:** Internal utility to compress conversation history > 6k tokens (using `js-tiktoken`).

